#  ‰ΩøÁî®RustËøõË°åLanceDBÁöÑÂàõÂª∫„ÄÅÊèíÂÖ•ÂíåÊü•ËØ¢Êï∞ÊçÆ‰ª•ÂèäÂà†Èô§Êìç‰Ωú

**LanceDB**ÊòØ‰∏ÄÁßç‰ΩøÁî®ÊåÅ‰πÖÂ≠òÂÇ®ÊûÑÂª∫ÁöÑÁî®‰∫éÁü¢ÈáèÊêúÁ¥¢ÁöÑÂºÄÊ∫êÊï∞ÊçÆÂ∫ìÔºåÊûÅÂ§ßÁÆÄÂåñ‰∫ÜÊ£ÄÁ¥¢„ÄÅËøáÊª§ÂíåÂµåÂÖ•ÁÆ°ÁêÜ„ÄÇ
**LanceDB**ÁöÑ‰∏ªË¶ÅÂäüËÉΩÂåÖÊã¨Ôºö
1. Áîü‰∫ßËßÑÊ®°ÁöÑÁü¢ÈáèÊêúÁ¥¢ÔºåÊó†ÈúÄÁÆ°ÁêÜÊúçÂä°Âô®„ÄÇ
2. Â≠òÂÇ®„ÄÅÊü•ËØ¢ÂíåËøáÊª§Áü¢Èáè„ÄÅÂÖÉÊï∞ÊçÆÂíåÂ§öÊ®°ÊÄÅÊï∞ÊçÆÔºàÊñáÊú¨„ÄÅÂõæÂÉè„ÄÅËßÜÈ¢ë„ÄÅÁÇπ‰∫ëÁ≠âÔºâ„ÄÇ
3. ÊîØÊåÅÁü¢ÈáèÁõ∏‰ººÊÄßÊêúÁ¥¢„ÄÅÂÖ®ÊñáÊêúÁ¥¢ÂíåSQL„ÄÇ
4. Êú¨Âú∞ÊîØÊåÅPythonÂíåJavascript/Typescript„ÄÇ
5. Èõ∂Êã∑Ë¥ù„ÄÅËá™Âä®ÁâàÊú¨ÁÆ°ÁêÜÔºåÁÆ°ÁêÜÊï∞ÊçÆÁâàÊú¨ËÄåÊó†ÈúÄÈ¢ùÂ§ñÂü∫Á°ÄËÆæÊñΩ„ÄÇ
6. GPUÊîØÊåÅÊûÑÂª∫Áü¢ÈáèÁ¥¢ÂºïÔºà`*`Ôºâ„ÄÇ
7. ÁîüÊÄÅÁ≥ªÁªüÈõÜÊàê

  - **LangChain**ü¶úÔ∏èüîó
  - **LlamaIndex**ü¶ô
  - **Apache-Arrow**
  - **Pandas**
  - **Polars**
  - **DuckDB**

## ÂÖ≥‰∫éLanceDB‰∏≠`Table`‰ªãÁªç
### `Table`ÁöÑ**ÊñπÊ≥ï**
- `name()`: Ëé∑ÂèñË°®ÁöÑÂêçÁß∞
- `schema()`: Ëé∑ÂèñË°®ÁöÑÊ®°Âºè
- `count_rows()`: Ëé∑ÂèñË°®‰∏≠ÁöÑË°åÊï∞
- `add()`: Ê∑ªÂä†ËÆ∞ÂΩïÊ∑ªÂä†Âà∞Ë°®‰∏≠Ôºå‰ΩÜ‰º†ÂÖ•ÁöÑÂèÇÊï∞ÊòØÈúÄË¶ÅÂÆûÁé∞`IntoArrow`ÁöÑÁ±ªÂûã
- `query()`: Êü•ËØ¢Ë°®‰∏≠ÁöÑËÆ∞ÂΩï
- `update()`: Êõ¥Êñ∞Ë°®‰∏≠ÁöÑËÆ∞ÂΩï
- `delete()`: Âà†Èô§Ë°®‰∏≠ÁöÑËÆ∞ÂΩï
- `create_index()`: ÂàõÂª∫Á¥¢Âºï
- `merge_insert()`: ÂêàÂπ∂ÊèíÂÖ•
- `vector_search()`: Áü¢ÈáèÊêúÁ¥¢
- `optimize()`: ‰ºòÂåñË°®
- `add_columns()`: Ê∑ªÂä†(Â§ö)Âàó
- `alter_columns()`: ‰øÆÊîπ(Â§ö)Âàó
- `drop_columns()`: Âà†Èô§(Â§ö)Âàó
- `version()`: Ëé∑ÂèñË°®ÁöÑÁâàÊú¨ÔºåÁî±‰∫éLanceDB‰ΩøÁî®ÁâàÊú¨ÊéßÂà∂ÂèòÂåñ
- `checkpoint()`: Ê†πÊçÆÊåáÂÆöÁâàÊú¨Ëé∑ÂèñÊ£ÄÊü•ÁÇπ
- `checkpoint_latest()`: Ëé∑ÂèñÊúÄÊñ∞Ê£ÄÊü•ÁÇπ
- `restore()`: ÊÅ¢Â§çÂà∞ÊåáÂÆöÁâàÊú¨
- `list_indices()`: ÂàóÂá∫Ë°®ÁöÑÁ¥¢Âºï

## `Schema`Ê®°ÂºèÂÆö‰πâ`Table`ÂÆö‰πâÊñπÂºè
![LanceDB SchemaÂÖ≥Á≥ªÂõæ](./lancedb-schema.png)

![LanceDB Table‰æùËµñÂÖ≥Á≥ªÂõæ](./lancedb-table.png)

## ÂàõÂª∫Á©∫Ë°®

1 ÂÆåÊï¥‰ª£Á†Å
```rust
use arrow_schema::{DataType, Field, Schema};
use lancedb::{connect, Result};
use std::sync::Arc;

#[tokio::main]
async fn main() -> Result<()> {
  let created_empty_talbe = create_empty_table().await?;
  println!(
    "Created empty table: {}, Table name: {}",
    created_empty_talbe,
    created_empty_talbe.name()
  );
  Ok(())
}

#[allow(unused)]
async fn create_empty_table() -> Result<LanceDbTable> {
	// ÂàõÂª∫Ê®°ÂºèÂÆö‰πâ
  let schema = Arc::new(Schema::new(vec![
    Field::new("id", DataType::Int32, false),
    Field::new("name", DataType::Utf8, false),
  ]));
	// ÂàõÂª∫Êï∞ÊçÆÂ∫ìURIÁõÆÂΩï
  let uri = "data/sample-lancedb";
	// ËøûÊé•Êï∞ÊçÆÂ∫ì
  let db = connect(uri).execute().await?;
	// ÂàõÂª∫‰∏Ä‰∏™Á©∫Ë°®
  let table = db
    .create_empty_table("empty_talbe", schema)
    .execute()
    .await?;
  Ok(table)
}
```

2. ÂåÖ‰æùËµñÊñá‰ª∂
`Cargo.toml`Êñá‰ª∂ÂÜÖÂÆπÂ¶Ç‰∏ãÔºö
```toml
lancedb = "0.7.0"
tokio = {version = "1.38.0", features = ["rt-multi-thread"]}
arrow-schema = "51.0"
```

3. ËøêË°åÁªìÊûúÂ¶Ç‰∏ã:
![LanceDBÂàõÂª∫Á©∫Ë°®](./lancedb-create-empty-table.png)


## ÂàõÂª∫Â∏¶ÂàùÂßãÂåñÊï∞ÊçÆÁöÑË°®

1. ÂÆåÊï¥‰ª£Á†ÅÂ¶Ç‰∏ã:
```rust
use arrow_schema::{DataType, Field, Schema};
use arrow_array::{Int32Array, RecordBatch, RecordBatchIterator, StringArray};
use lancedb::{connect, Result, Table as LanceDbTable};
use std::sync::Arc;

#[tokio::main]
async fn main() -> Result<()> {
  let created_table_with_data = create_table_with_data().await?;
  println!(
    "Created table with data: {}, Table name: {}",
    created_table_with_data,
    created_table_with_data.name()
  );
  Ok(())
}

#[allow(unused)]
async fn create_table_with_data() -> Result<LanceDbTable> {
  // ÂàõÂª∫Êú¨Âú∞Êï∞ÊçÆÂ∫ìURIÁõÆÂΩï
  let uri = "data/sample-lancedb";
  // ËøûÊé•Êï∞ÊçÆÂ∫ì
  let db = connect(uri).execute().await?;

  // ÂàõÂª∫Ê®°ÂºèÂÆö‰πâ
  let schema = Arc::new(Schema::new(vec![
    Field::new("id", DataType::Int32, false),
    Field::new("name", DataType::Utf8, false),
  ]));

  // ÂàùÂßãÂåñ`ids`ÂàóÁöÑÊï∞ÊçÆ
  let ids = Int32Array::from(vec![1, 2, 3]);
  // ÂàùÂßãÂåñ`name`ÂàóÁöÑÊï∞ÊçÆ
  let names = StringArray::from(vec!["Alice", "Bob", "Lily"]);
  // ‰ΩøÁî®`Schema`‰ª•ÂèäÂàóÊï∞ÊçÆÂàõÂª∫`RecordBatch`
  let batch = RecordBatch::try_new(schema.clone(), vec![Arc::new(ids), Arc::new(names)])?;
  // ‰ΩøÁî®`RecordBatch`ÂàõÂª∫`RecordBatchIterator`
  let batchs = RecordBatchIterator::new(vec![batch].into_iter().map(Ok), schema);
  // ÂàõÂª∫Ë°®ÔºåÂπ∂ÊèíÂÖ•ÂàùÂßãÂåñÊï∞ÊçÆ
  let table = db
    .create_table("table_with_person", batchs)
    .execute()
    .await?;
  Ok(table)
}
```
2. ÂåÖ‰æùËµñÊñá‰ª∂
`Cargo.toml`Êñá‰ª∂ÂÜÖÂÆπÂ¶Ç‰∏ãÔºö
```toml
lancedb = "0.7.0"
tokio = {version = "1.38.0", features = ["rt-multi-thread"]}
arrow-schema = "51.0"
```
3. ËøêË°åÁªìÊûúÂ¶Ç‰∏ã:
![LanceDBÂàõÂª∫Â∏¶ÂàùÂßãÂåñÊï∞ÊçÆÁöÑË°®](./lancedb-create-table-with-data.png)

## ÂàùÂßãÂåñËÆ∞ÂΩïÂπ∂ÂàõÂª∫Ë°®

1. ÂÆåÊï¥‰ª£Á†Å
```rust
use arrow_array::types::Float32Type;
use arrow_array::{FixedSizeListArray, Int32Array, RecordBatch, RecordBatchIterator, StringArray};
use arrow_schema::{DataType, Field, Schema};
use lancedb::arrow::IntoArrow;
use lancedb::{connect, Result, Table as LanceDbTable};
use std::sync::Arc;

#[tokio::main]
async fn main() -> Result<()> {
  let created_table_with_records = create_table_with_records().await?;
  println!(
    "Created table with records: {}, Table name: {}",
    created_table_with_records,
    created_table_with_records.name()
  );
  Ok(())
}

#[allow(unused)]
async fn create_table_with_records() -> Result<LanceDbTable> {
  let uri = "data/sample-lancedb";
  let db = connect(uri).execute().await?;

  let initial_data = create_some_records()?;
  let tbl = db.create_table("my_table", initial_data).execute().await?;

  let new_data = create_some_records()?;
  // NOTICE: Âè™ÊúâÂÆûÁé∞‰∫Ü IntoArrow ÁöÑÁ±ªÂûãÊâçËÉΩ‰ΩøÁî®`add`ÊñπÊ≥ïÔºåÂç≥`create_some_records`ËøîÂõûÁöÑÁ±ªÂûã
  tbl.add(new_data).execute().await?;
  Ok(tbl)
}

#[allow(unused)]
fn create_some_records() -> Result<impl IntoArrow> {
  const TOTAL: usize = 1000;
  const DIM: usize = 128;

  let schema = Arc::new(Schema::new(vec![
    Field::new("id", DataType::Int32, false),
    Field::new(
      "vector",
      DataType::FixedSizeList(
        Arc::new(Field::new("item", DataType::Float32, true)),
        DIM as i32,
      ),
      true,
    ),
  ]));

  let batch = RecordBatch::try_new(
    schema.clone(),
    vec![
      Arc::new(Int32Array::from_iter_values(0..TOTAL as i32)),
      Arc::new(
        FixedSizeListArray::from_iter_primitive::<Float32Type, _, _>(
          (0..TOTAL).map(|_| Some(vec![Some(1.0); DIM])),
          DIM as i32,
        ),
      ),
    ],
  )
  .unwrap();
  let batches = RecordBatchIterator::new(vec![batch].into_iter().map(Ok), schema.clone());
  Ok(Box::new(batches))
}
```

2. ÂåÖ‰æùËµñÊñá‰ª∂
`Cargo.toml`Êñá‰ª∂ÂÜÖÂÆπÂ¶Ç‰∏ãÔºö
```toml
lancedb = "0.7.0"
tokio = {version = "1.38.0", features = ["rt-multi-thread"]}
arrow-schema = "51.0"
arrow-array = "51.0"
```

3. ËøêË°åÁªìÊûúÂ¶Ç‰∏ã:
![LanceDBÂàùÂßãÂåñËÆ∞ÂΩïÂπ∂ÂàõÂª∫Ë°®](./lancedb-table-with-records.png)

##  ÊâìÂºÄÂ∑≤Â≠òÂú®ÁöÑË°®
1. ÂÆåÊï¥‰ª£Á†Å
```rust
use lancedb::{connect, Result, Table as LanceDbTable};

async fn main() -> Result<()> {
  let opened_table = open_with_existing_table().await?;
  println!(
    "Opened table: {}, Table name: {}",
    opened_table,
    opened_table.name()
  );
}

#[allow(unused)]
async fn open_with_existing_table() -> Result<LanceDbTable> {
  let uri = "data/sample-lancedb";
  let db = connect(uri).execute().await?;
  let table = db.open_table("my_table").execute().await?;
  Ok(table)
}
```

2. ÂåÖ‰æùËµñÊñá‰ª∂
```toml
lancedb = "0.7.0"
tokio = {version = "1.38.0", features = ["rt-multi-thread"]}
```

3. ËøêË°åÁªìÊûúÂ¶Ç‰∏ã:
![LanceDBÊâìÂºÄÂ∑≤Â≠òÂú®ÁöÑË°®](./lancedb-open-table.png)

## Âà†Èô§Ë°®ËÆ∞ÂΩï

1. ÂÆåÊï¥‰ª£Á†Å
```rust
use lancedb::{connect, Result};

#[tokio::main]
async fn main() -> Result<()> {
  let queried_result = query_table().await?;
  println!("Query result: {:?}", queried_result);

  delete_table_records().await?; // Ê†πÊçÆÊù°‰ª∂Âà†Èô§Ë°®‰∏≠ÁöÑËÆ∞ÂΩï
  Ok(())
}

#[allow(unused)]
async fn delete_table_records() -> Result<()> {
  let uri = "data/sample-lancedb";
  let db = connect(uri).execute().await?;
  let table = db.open_table("my_table").execute().await?;
  table.delete("id > 24").await?;
  Ok(())
}
```
2. ÂåÖ‰æùËµñÊñá‰ª∂
```toml
lancedb = "0.7.0"
tokio = {version = "1.38.0", features = ["rt-multi-thread"]}
```

## Âà†Èô§Ë°®
1. ÂÆåÊï¥‰ª£Á†Å
```rust
use lancedb::{connect, Result};

#[tokio::main]
async fn main() -> Result<()> {
  let queried_result = query_table().await?;
  println!("Query result: {:?}", queried_result);

  drop_table().await?; // Âà†Èô§ data/sample-lancedb/my_table
  Ok(())
}

#[allow(unused)]
async fn drop_table() -> Result<()> {
  let uri = "data/sample-lancedb";
  let db = connect(uri).execute().await?;
  db.drop_table("my_table").await?;
  Ok(())
}
```
2. ÂåÖ‰æùËµñÊñá‰ª∂
```toml
lancedb = "0.7.0"
tokio = {version = "1.38.0", features = ["rt-multi-thread"]}
```

## Âà†Èô§Êï∞ÊçÆÂ∫ì
1. ÂÆåÊï¥‰ª£Á†Å
```rust
use lancedb::{connect, Result};

#[tokio::main]
async fn main() -> Result<()> {
  let queried_result = query_table().await?;
  println!("Query result: {:?}", queried_result);

  drop_database().await?; // Âà†Èô§ data/sample-lancedb
  Ok(())
}

#[allow(unused)]
async fn drop_database() -> Result<()> {
  let uri = "data/sample-lancedb";
  let db = connect(uri).execute().await?;
  db.drop_db().await?;
  Ok(())
}
```
2. ÂåÖ‰æùËµñÊñá‰ª∂
```toml
lancedb = "0.7.0"
tokio = {version = "1.38.0", features = ["rt-multi-thread"]}
```

## Êü•ËØ¢Ë°®ËÆ∞ÂΩï
1. ÂÆåÊï¥‰ª£Á†Å
```rust
use lancedb::{connect, Result};

#[tokio::main]
async fn main() -> Result<()> {

  let queried_result = query_table().await?;
  println!("Query result: {:?}", queried_result);
  Ok(())
}

#[allow(unused)]
async fn query_table() -> Result<VectorQuery> {
  let uri = "data/sample-lancedb";
  let db = connect(uri).execute().await?;
  let table = db.open_table("my_table").execute().await?;
  let result = table.query().nearest_to(&[1.0; 128])?;
  Ok(result)
}
```

2. ÂåÖ‰æùËµñÊñá‰ª∂
```toml
lancedb = "0.7.0"
tokio = {version = "1.38.0", features = ["rt-multi-thread"]}
```

3. ËøêË°åÁªìÊûúÂ¶Ç‰∏ã:
![LanceDBÊü•ËØ¢Ë°®ËÆ∞ÂΩï](./lancedb-query-table.png)

## Êõ¥Êñ∞Ë°®ËÆ∞ÂΩï
1. ÂÆåÊï¥‰ª£Á†Å
```rust
use lancedb::{connect, Result};

#[tokio::main]
async fn main() -> Result<()> {

  update_table().await?;
  Ok(())
}

#[allow(unused)]
async fn update_table() -> Result<()> {
  let uri = "data/sample-lancedb";
  let db = connect(uri).execute().await?;
  let table = db.open_table("table_with_person").execute().await?;
  println!("Before update: {:?}", table.query());
  table
    .update()
    .only_if("id=0")
    .column("name", "Bob")
    .execute()
    .await?; // Bob -> Halzzz

  Ok(())
}
```

2. ÂåÖ‰æùËµñÊñá‰ª∂
```toml
lancedb = "0.7.0"
tokio = {version = "1.38.0", features = ["rt-multi-thread"]}
```

## ÊÄªÁªì
Êú¨ÊñáËØ¶ÁªÜ‰ªãÁªç‰∫ÜÂ¶Ç‰Ωï‰ΩøÁî®RustÁºñÁ®ãËØ≠Ë®Ä‰∏éLanceDBËøõË°å‰∫§‰∫íÔºå
ÂåÖÊã¨Ë°®ÁöÑÂàõÂª∫„ÄÅÊèíÂÖ•Êï∞ÊçÆ„ÄÅÊü•ËØ¢„ÄÅÊõ¥Êñ∞ÂíåÂà†Èô§Êìç‰Ωú„ÄÇ
ÈÄöËøáËøô‰∫õÁ§∫‰æãÔºåÂ±ïÁ§∫‰∫ÜLanceDBÂú®Â§ÑÁêÜÁü¢ÈáèÊï∞ÊçÆÂíåÊîØÊåÅÂ§öÊ®°ÊÄÅÊï∞ÊçÆÊñπÈù¢ÁöÑÂº∫Â§ßÂäüËÉΩÔºå
‰ª•ÂèäÂ¶Ç‰ΩïÈÄöËøáRust‰ª£Á†ÅÂÆûÁé∞Ëøô‰∫õÊìç‰Ωú„ÄÇ
LanceDBÊèê‰æõ‰∫Ü‰∏∞ÂØåÁöÑAPIÊé•Âè£ÔºåÁÆÄÂåñ‰∫ÜÊï∞ÊçÆÂ∫ìÊìç‰ΩúÔºå
‰ΩøÂæóÂºÄÂèëËÄÖËÉΩÂ§üÈ´òÊïàÂú∞ÁÆ°ÁêÜÂíåÊü•ËØ¢Êï∞ÊçÆ„ÄÇ

Â∏åÊúõÈÄöËøáÊú¨ÊñáÁöÑËÆ≤Ëß£ÔºåÊÇ®ËÉΩÂ§üÊõ¥Â•ΩÂú∞ÁêÜËß£Âπ∂Â∫îÁî®LanceDBÊù•Ëß£ÂÜ≥ÂÆûÈôÖÈóÆÈ¢ò„ÄÇ

## ÂçöÂÆ¢Âú∞ÂùÄ
- [ÂçöÂÆ¢ÊñáÁ´†](https://yuxuetr.com/blog/2024/07/17/lancedb-table)
